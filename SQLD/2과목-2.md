## 2-9 서브쿼리

- 서브쿼리

    - 하나의 SQL문 안에 포함된 또 다른 SQL문을 의미

    - 반드시 괄호 안에 묶어야함

- 서브쿼리 사용 가능한 위치

    - SELELT 절

    - FROM 절

    - WHERE 절

- 서브쿼리 종류

    - 동작하는 방식에 따라

        - 비연관 서브쿼리

            - 서브쿼리에 메인쿼리 테이블의 컬럼을 포함하지 않은 형태의 서브쿼리

            - 서브쿼리가 메인 쿼리의 값을 참조하지 않고 독립적으로 실행됨

        - 연관 서브쿼리

            - 서브쿼리에 메인쿼리 테이블의 컬럼을 포한하는 형태의 서브쿼리

            - 메인 쿼리의 각 행에 대해 서브쿼리가 실행됨

    - 위치에 따라

        -  스칼라 서브 쿼리

            - SELECT 절에 사용하는 서브쿼리

            - 서브쿼리 결과를 마치 하나의 컬럼처럼 사용하기 위해 주로 사용

        - 인라인 뷰

            - FROM 절에 사용하는 서브 쿼리

            - 서브쿼리 결과를 테이블처럼 사용하기 위해 주로 사용

        - WHERE 절 서브쿼리

            - 가장 일반적인 서브쿼리

            - 비교 상수 자리에 값을 전달하기 위한 목적으로 주로 사용(상수항 대체)

- EXISTS/ NOT EXISTS 연산자

    - 서브쿼리 조건에 따라 메인쿼리의 출력 결과가 달라짐

    - 서브쿼리 SELECT 절의 출력 형태는 중요하지 않음

    - EXISTS

        - 서브쿼리 결과가 하나라도 존재하면 메인쿼리 출력

    - NOT EXISTS

        - 서브쿼리 결과가 존재하지 않으면 메인쿼리 데이터 출력

    - 다중컬럼 서브쿼리

        - 서브쿼리 결과가 여러 컬럼을 리턴하는 형태

        - 메인쿼리와 비교하는 컬럼이 2개 이상인 형태

    - 상호연관 서브쿼리

        - 메인쿼리와 서브쿼리 간의 비교를 수행하는 형태

        - 비교할 집단이나 조건은 서브쿼리에 명시되어야 함

- 인라인뷰

    - 쿼리 안의 뷰의 형태로, 테이블처럼 조회할 데이터를 정의하기 위해 사용

    - 테이블명이 존재하지 않기 때문에 다른 테이브로가 조인시 반드시 테이블 별칭을 명시해야함


- 스칼라 서브쿼리

    - SELECT 절에 사용하는 쿼리로, 마치 하나의 컬럼처럼 표현하기 위해 사용

    - 각 행마다 스칼라 서브쿼리 결과가 하나여야 함

     - ORDER BY 절 사용 불가

## 2-10 집합 연산자

- 집합 연산자

    - SELECT문과 SELECT 문 사이에 집합 연산자 정의

- 합집합 

    - 두집합의 총합 출력

    - UNION과 UNION ALL 사용 가능

    1) UNION 

        - 중복된 데이터는 한 번만 출력

        - 중복된 데이터를 제거하기 위해 내부적으로 정력 수행

        - 중복된 데이터가 없을 경우는 UNION 대신 UNION ALL 사용 권고

- 교집합

    - 두 집합 사이에 INTERSECT

    - 두 집합의 공통으로 있는 행 출력

- 차집합

    - 두 집합 사이에 MINUS 전달

    - 두 집합의 차집합 출력

- 집합 연산자 사용시 주의 사항

    - 두 집합의 컬럼 수 일치

    - 두 집합의 컬럼 순서 일치

    - 두 집합의 각 컬럼의 데이터 타입 일치

    - 각 컬럼의 사이즈는 달라도 됨

    - 개별 SELECT 문에 ORDER BY 전달 불가

## 2-11 그룹 함수

- 그룹 함수

    - 숫자 함수 중 여러 값을 전달하여 하나의 요약 값을 출력하는 다중행 함수

    - 수학/ 통계 함수들

    - GROUP BY 절에 의해 그룹별 연산 결과를 리턴 함

    - 반드시 한 컬럼만 전달

- 여러 함수들 이름을 보고 직관적으로 접근 할것.

## 2-12 윈도우 함수

- 윈도우 펑션

    - 서로 다른 행의 비교나 연산을 위해 만든 함수

    - GROUP BY를 쓰지 않고 그룹 연산 가능

    - PARTITION BY 절

        - 출력할 총 데이터 수 변화 없이 그룹 연산 수행할 GROUP BY 컬럼

    - ORDER BY 절

        - RANK의 경우 필수

        - SUM, AVG, MIN, MAX, COUNT 등은 누적값 출력 시 사용

    - ROW/ RANGE BETWEEN A AND B

        - 연산 범위 설정

        - GROUP BY절 필수

- 순위 관련 함수

    - RANK

        1. RANG WITHIN GROUP

            - 특정 값에 대한 순위 확인(RANK WITHIN)

            - 윈도우 함수가 아닌 일반 함수

        2. RANK() OVER()

            - 전체 또는 특정 그룹 내 값의 순위 확인

            - ORDER BY 절 필수

            - 순위를 구할 대상을 ORDER BY 절에 명시

        3. DENSE_RANK

            - 누적 순위

            - 값이 값을 때 동일한 순위 부여 후 다음 순위가 바로 이어지는 순위 부여 방식 

            - 1등이 5명이라도 그다음은 2등

        4. ROW_NUMBER

            - 연속된 행번호

            - 동일한 순위를 인정하지 않고 단순히 순서대로 나열한대로의 순서 값리턴

- LAG, LEAD

    - 행 순서대로 각각 이전 값(LAG), 이후 값LEAD 가져오기

    - ORDER BY 절 필수

- FIRST?_VALUE, LAST_VALUE

    - 정령 순서대로 정해진 범위에서의 처음 값, 마지막 값 출력

    - 순서와 범위 정의에 따라 최솟값과 최댓값 리턴 가능

- NILE

    - 행을 특정 컬럼 순서에 따라 정해진 수의 그룹으로 나누기 위한 함수

    - 그룹 번호가 리턴됨

- 비율 관련 함수

    - RATIO_TO_REPORT

         - 각 값이 전체 합에서 차지하는 비율을 계산

    - CUME_DIST

        - 해당 값보다 작거나 값은 값의 비율을 계산

    - PERCEN_RANK

        - 주어진 값이 데이터 집합 내에서 상대적으로 어디에 위치 하는지를 비율로 나타내느 함수

## 2-13 TOP N QUERY

- TOP N QUERY

    - 페이징 처리를 효과적으로 수행하기 위해 사용

    - 전체 결과에서 특정 N개 추출

- TOP-N 행 추출 방법

    - ROWNUM

    - RANK

    - FETCH

    - TOP N (SQL Server)

- ROWNUM

    - 출력된 데이터 기준으로 행 번호 부여

    - 절대적인 행 번호가 아닌 가상의 번호이므로 특정 행을 지정할 수 없음

    - 항상 불변하는 절대적 번호가 아니므로 '=' 연산자 단독 전달 불가

- FETCH절

    - 출력될 행의 수를 제한하는 절

    - ORACLE 12C 이상부터 제공

    - SQL Server 사용 가능

- TOP N 쿼리

    - SQL Server 에서의 상위 n개 행 추출 문법

    - 서브쿼리 사용 없이 하나의 쿼리로 정렬된 순서대로 상위 n개 추출 가능


## 2-14 계층형 질의

- 계층형 질의

    - 하나의 테이블 내 각 행끼리 관계를 가질 때, 연결고리를 통해 행과 행 사이의 계층을 표현하는 기법

    - PRIOR의 위치에 따라 연결하는 데이터가 달라짐

- 계층형 질의 조건

    - CONNECT BY 절 조건

        - 계층 구조를 설정하는 조건

        - START WITH 절에서 시작한 데이터로부터 부모-자식 관계를 탐색하는 규칙을 정의

        - 이 조건이 성립하지 않으면, 더이상 자식 관계를 연결하지 않음

    - WHERE 절 조건

        - 전체 결과를 필터링 하는데 사용

        - START WITH과 CONNECT BY로 연결된 모든 결고가 출력된 후, WHERE절 조건에 맞는 데이터만 선택하여 출력

    
- 계층형 질의 가상 컬럼

    - LEVEL: 각 DEPTH를 표현

    -  CONNECT_BY_ISLEAF: LEAF NODE 여부

- 계층형 질의 가상 함수

    - CONNECT_BY_ROOT 컬럼명: 루트노드의 해당하는 컬럼값

    - SYS_CONNECT_BY_PATH: 이어지는 경로 출력

    - ORDER SIBLINGS BY 컬럼: 같은 LEVEL일 경우 정렬 수행

    - CONNECT_BY_ISCYCLE: 계층형 쿼리의 결과에서 순환이 발생했는지 여부


## 2-15 PIVOT과 UNPIVOT

- 데이터 구조

    - LONG DATA

        - 하나의 속성이 하나의 컬럼으로 정의되어 값들이 여러 행으로 쌓이는 구조

        - RDBMS의 테이블 설계 방식

    - WIDE DATA

        - 행과 컬럼에 유의미한 정보 전달을 목적으로 작성하는 교차표

        - 하나의 속성값이 여러 컬럼으로 분리되어 표현

        - RDMS에서 WIDE 형식으로 테이블 설계시 값이 추가될때마다 컬럼이 추가돼야 하므로 비효율적

- 데이터 구조 변경

    - PIVOT: LONG -> WIDE

        - 교차표를 만드는 기능

        - STACK 컬럼, UNSTACK 컬럼, VALUE컬럼의 정의가 중요

    - UNPIVOT: WIDE -> LONG

        - WIDE 데이터를 LONG 데이터로 변경하는 문법

## 2-16 정규 표현식

- 정규 표현식

    - 문자열의 공통된 규칙을 보다 일반화 하여 표현하는 방법

    - 정규 표현식으로 사용 가능한 문자함수 제공

    - ㅈㄴ 많으니깐 눈치껏 맞춰야되ㅏㅁ

- REGEXP_REPLACE

    - 특징

        - 바꿀 문자열 생략 시 문자열 삭제

        - 검색위치 생략 시 1

        - 발견횟수 생략 시 0

    - 옵션

        - C: 대소를 구분하여 검색

        - i: 대소를 구분하지 않고 검색

        - m: 패턴을 다중라인으로 선언 가능

- REGEXP_SUBSTR

    - 특징

        - 검색위치 생략 시 1

        - 발견 횟수 생략 시 1

        - 추출그룹은 서브패턴을 추출 시 그 중 추출할 서브패턴 번호

- REGEXP_INSTR

    - 특징

        - 시작위치 생략 시 처음부터 확인(기본값: 1)

        - 발견횟수 생략 시 처음 발견된 문자열 위치 리턴